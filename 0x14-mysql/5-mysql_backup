#!/usr/bin/env bash
# This script creates a backup of custom MySQL databases and compresses it.

if [ $# -ne 1 ]; then
    echo "Usage: $0 <mysql_root_password>"
    exit 1
fi

PASSWORD=$1
DATE=$(date +%d-%m-%Y)
BACKUP_FILE="backup.sql"
ARCHIVE_FILE="${DATE}.tar.gz"

# Get a list of user-created databases
DATABASES=$(mysql -uroot -p"${PASSWORD}" -e "SHOW DATABASES;" | grep -Ev "(information_schema|mysql|performance_schema|sys|Database)")

# Check if there are databases to back up
if [ -z "$DATABASES" ]; then
    echo "No databases to back up."
    exit 1
fi

# Dump the databases
mysqldump -uroot -p"${PASSWORD}" --databases ${DATABASES} > "${BACKUP_FILE}" 2>/dev/null

# Check if the mysqldump command was successful
if ! [ -s "${BACKUP_FILE}" ]; then
    echo "Failed to dump databases. Please check your credentials and database names."
    exit 1
fi

# Compress the dump
tar -czf "${ARCHIVE_FILE}" "${BACKUP_FILE}"
echo "Backup completed and saved to ${ARCHIVE_FILE}"
